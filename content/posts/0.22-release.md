---
title: "Pyodide 0.22.0 release"
date: 2022-12-27 # TODO: update date before merging
tags: ["release", "announcement"]
author: "Gyeongjae Choi and Hood Chatham on behalf of the Pyodide team"
showToc: true
TocOpen: false
hidemeta: false
comments: false
# description: ""
disableHLJS: true # to disable highlightjs
disableShare: false
hideSummary: false
searchHidden: true
ShowReadingTime: true
ShowBreadCrumbs: true
ShowPostNavLinks: true
---

Pyodide 0.22 is a major release focused on improving the foreign function
interface (FFI) between Python and JavaScript. We also improved the systems for
building, loading, and testing packages. We added support for creating virtual
environments that execute code using node Pyodide. This is intended for testing
packages against Pyodide.

We unvendored the Pyodide package manager and matplotlib backend into separate
repositories.

Additionally, we added 16 new packages to Pyodide, including geopandas and
fiona, which have been a longstanding request from the geospatial community.

For a complete list of changes, please see the
[changelog](https://pyodide.org/en/stable/project/changelog.html#version-0-22-0).

## New JavaScript APIs

We added support for mounting a folder from the local filesystem into the
Pyodide filesystem using the Chrome [File System Access
API](https://developer.chrome.com/articles/file-system-access/). If you acquire
a directory handle (say from
[showDirectoryPicker](https://developer.mozilla.org/en-US/docs/Web/API/Window/showDirectoryPicker)) then you can mount this directory handle 

We added new stream handling API.

## Improvements to the foreign function interface

We made a large number of minor improvements to the foreign function interface, particularly to the use of JavaScript objects in Python.

We split the `pyodide.ffi.JsProxy` class into several subclasses e.g., `JsMap`,
`JsBuffer`, etc. These classes can be used for static or runtime type analysis
of JavaScript objects. We made major improvements to the static type analysis
system, including a typeshed for some commonly-used objects in the JavaScript
global scope.

We improved the comprehensiveness of the APIs for using several common
JavaScript objects. JavaScript `Array`s now implement the full
`collections.abc.MutableSequence` API and so can be used as drop-in replacements
for `list`s in most circumstances. For instance, they can now be used in `match`
blocks. Similarly, JavaScript `Map`s implement the `MutableMap` API. We also
added an `as_object_map` method, which can be used to treat a JavaScript object
as a dictionary. For example, `run_js("({a:2, b:3})").as_object_map()["a"]` returns 2 (whereas `run_js("({a:2, b:3})")["a"]` raises `TypeError: 'JsProxy' object is not subscriptable`).

We also added a `__get__` descriptor to `JsCallable` so that it is possible to
use a JavaScript function as a method for a Python class:
```py
class T:
    def __init__(self, a, b):
        self.a = a
        self.b = b
    
    js_get_attr = run_js(
        """
        (function(name){
            // `this` binds the `self` parameter of the method!
            return this[name];
        })
        """
    )

t = T(3, 5)
t.js_get_attr("a") # 3
t.js_get_attr("b") # 5
```
In most cases this is probably not useful, but it is cool that it is *possible*. 

In the reverse direction, it is possible to request that invocations of a
`PyProxy` pass `this` as the first argument:
```js
let o = {a:3, b:5};
o.py_get_attr = pyodide.runPython(`
def py_get_attr(self, name):
    return getattr(self, name)
py_get_attr
`).captureThis();
o.py_get_attr("a"); # 3
o.py_get_attr("b"); # 5
```


The foreign function interface now has bidirectional support for async iterators
and async iterables. Python generators and async generators can now be used as
drop-in replacements for JavaScript generators and vice versa. There is new
lifetime management when using JavaScript generators from Python which should
make them much easier to use them.

There is a lot of work left to do here, particularly to improve static type
analysis, but these improvements filled a lot of minor holes.


## Unvendoring Pyodide-specific packages

Pyodide includes a few pure Python packages written specifically for use with
Pyodide. We have unvendored these packages into standalone repositories.

The following packages have been unvendored:

- [pytest-pyodide](https://github.com/pyodide/pytest-pyodide):
a pytest plugin for testing dedicated Pyodide applications.
- [micropip](https://github.com/pyodide/micropip):
a lightweight package manager for Pyodide and Python in the browser.
- [matplotlib-pyodide](https://github.com/pyodide/matplotlib-pyodide):
a matplotlib HTML backend.

By separating these packages from the main Pyodide repository, we hope to
facilitate their development and make it easier for the Python-in-the-browser
community to use and improve them. They depend on the Pyodide ffi modules so for
now it is still difficult to use them separate from Pyodide. In the future we
hope to also unvendor the foreign function interface so that other Emscripten
builds of CPython can use it.

## Pyodide virtual environments

We added support for creating virtual environments that run Python using node
Pyodide. This is particularly exciting because it makes it simpler than ever to
test pure Python packages against Pyodide. In many cases it is possible to run
the tests in the same way as in native Python (though building and installing
the dependencies may take extra care). As a proof of concept, we added Pyodide
to [numpy CI](https://github.com/numpy/numpy/blob/main/.github/workflows/emscripten.yml).

### Acknowledgements

Thanks to everyone who contributed code to this release and all users who
reported issues and provided feedback. Thanks to the Jupyterlite and PyScript
developers for their feedback and contributions. Thanks to the Emscripten team
for their helpful and responsive support. Thanks to Brett Cannon and Christian
Heimes for continuing to work on improving core Python support for the
Emscripten platform.  We would also like to thank the entire
Python-in-the-browser community for experimentation and discussion which have
helped determine the direction both of Pyodide and the broader
Python-in-the-browser project.

The following people commited to Pyodide in this release:

Aierie, dataxerik, David Lechner, Deepak Cherian, Filipe, Gyeongjae Choi,
Hood Chatham, H.Yamada, Jacques Boscq, Jeremy Tuloup, Joe Marshall,
John Wason, Loïc Estève, partev, Patrick Arminio, Péter Ferenc Gyarmati, Prete,
Qijia Liu, Roman Yurchak, skelsec, Starz0r, Will Lachance, YeonWoo, Yizhi Liu
